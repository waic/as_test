name: Check and Resolve Duplicate Filenames

on:
  push:
    paths:
      - 'WAIC-TEST/HTML_è¦‹é€ã‚Š/**'
      - 'WAIC-TEST/HTML_æœªç€æ‰‹/**'
  pull_request:
    paths:
      - 'WAIC-TEST/HTML_è¦‹é€ã‚Š/**'
      - 'WAIC-TEST/HTML_æœªç€æ‰‹/**'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

env:
  BRANCH_PREFIX: fix-duplicate-files

jobs:
  check-duplicates:
    runs-on: ubuntu-latest
    outputs:
      duplicates_found: ${{ steps.check.outputs.duplicates_found }}
      duplicate_list: ${{ steps.check.outputs.duplicate_list }}
      files_to_delete: ${{ steps.check.outputs.files_to_delete }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check for duplicate filenames
        id: check
        run: |
          echo "Checking for duplicate filenames between HTML_è¦‹é€ã‚Š and HTML_æœªç€æ‰‹ folders..."
          
          # Get basenames from both directories
          dir1_files=$(find "WAIC-TEST/HTML_è¦‹é€ã‚Š" -name "*.md" -exec basename {} \; 2>/dev/null | sort)
          dir2_files=$(find "WAIC-TEST/HTML_æœªç€æ‰‹" -name "*.md" -exec basename {} \; 2>/dev/null | sort)
          
          # Find duplicates
          duplicates=$(comm -12 <(echo "$dir1_files") <(echo "$dir2_files"))
          
          if [ -n "$duplicates" ]; then
            echo "âŒ Duplicate filenames found:"
            echo "$duplicates"
            echo ""
            echo "Files exist in both HTML_è¦‹é€ã‚Š and HTML_æœªç€æ‰‹:"
            
            # Create detailed list for issue and files to delete
            issue_body=""
            files_to_delete=""
            for file in $duplicates; do
              echo "  - $file"
              miokuri_path=$(find WAIC-TEST/HTML_è¦‹é€ã‚Š -name "$file" -exec echo {} \;)
              michakushu_path=$(find WAIC-TEST/HTML_æœªç€æ‰‹ -name "$file" -exec echo {} \;)
              echo "    ğŸ“ HTML_è¦‹é€ã‚Š/$miokuri_path"
              echo "    ğŸ“ HTML_æœªç€æ‰‹/$michakushu_path"
              issue_body="$issue_body- \`$file\`\n  - ğŸ“ \`$miokuri_path\`\n  - ğŸ“ \`$michakushu_path\`\n\n"
              files_to_delete="$files_to_delete$michakushu_path\n"
            done
            
            echo "duplicates_found=true" >> $GITHUB_OUTPUT
            echo "duplicate_list<<EOF" >> $GITHUB_OUTPUT
            echo -e "$issue_body" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "files_to_delete<<EOF" >> $GITHUB_OUTPUT
            echo -e "$files_to_delete" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            
            # Don't fail, proceed to auto-fix
          else
            echo "âœ… No duplicate filenames found between the two directories."
            echo "duplicates_found=false" >> $GITHUB_OUTPUT
          fi

  auto-fix-duplicates:
    needs: check-duplicates
    if: needs.check-duplicates.outputs.duplicates_found == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Delete duplicate files from HTML_æœªç€æ‰‹
        run: |
          echo "Deleting duplicate files from HTML_æœªç€æ‰‹ folder..."
          
          # Delete files listed in files_to_delete
          echo -e "${{ needs.check-duplicates.outputs.files_to_delete }}" | while read -r file; do
            if [ -n "$file" ] && [ -f "$file" ]; then
              echo "Deleting: $file"
              rm "$file"
            fi
          done

      - name: Create Pull Request for duplicate removal
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "ğŸ—‘ï¸ Remove duplicate files from HTML_æœªç€æ‰‹ folder [skip ci]"
          title: "ğŸ—‘ï¸ é‡è¤‡ãƒ•ã‚¡ã‚¤ãƒ«ã®è‡ªå‹•å‰Šé™¤ (HTML_æœªç€æ‰‹)"
          body: |
            ## æ¦‚è¦
            HTML_è¦‹é€ã‚Š ã¨ HTML_æœªç€æ‰‹ ãƒ•ã‚©ãƒ«ãƒ€é–“ã§é‡è¤‡ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œå‡ºã—ã€HTML_æœªç€æ‰‹ ã‹ã‚‰è‡ªå‹•å‰Šé™¤ã—ã¾ã—ãŸã€‚

            ## å‰Šé™¤ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«
            ${{ needs.check-duplicates.outputs.duplicate_list }}

            ## å‰Šé™¤ç†ç”±
            - ãƒ•ã‚¡ã‚¤ãƒ«ãŒ HTML_è¦‹é€ã‚Š ãƒ•ã‚©ãƒ«ãƒ€ã«æ—¢ã«å­˜åœ¨ã™ã‚‹ãŸã‚
            - é‡è¤‡ã‚’é¿ã‘ã‚‹ãŸã‚ã« HTML_æœªç€æ‰‹ ã‹ã‚‰å‰Šé™¤

            ## ç¢ºèªäº‹é …
            - [ ] å‰Šé™¤ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ãŒ HTML_è¦‹é€ã‚Š ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¨åŒä¸€ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
            - [ ] å‰Šé™¤ã«ã‚ˆã‚Šå½±éŸ¿ã‚’å—ã‘ã‚‹ä»–ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒãªã„ã“ã¨ã‚’ç¢ºèª

            ## è‡ªå‹•å‡¦ç†æƒ…å ±
            - **å‡¦ç†æ—¥æ™‚**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
            - **æ¤œå‡ºã‚³ãƒŸãƒƒãƒˆ**: ${{ github.sha }}
            - **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼**: ${{ github.workflow }}
            - **å®Ÿè¡Œã‚¤ãƒ™ãƒ³ãƒˆ**: ${{ github.event_name }}

            > ã“ã®PRã¯GitHub Actionsã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚ãƒãƒ¼ã‚¸å‰ã«å†…å®¹ã‚’ã”ç¢ºèªãã ã•ã„ã€‚
          branch: ${{ env.BRANCH_PREFIX }}-${{ github.run_number }}
          base: master
          delete-branch: true

