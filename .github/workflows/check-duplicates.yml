name: Check and Resolve Duplicate Filenames

on:
  pull_request:
    types: [closed]
    branches:
      - master
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

env:
  BRANCH_PREFIX: fix-duplicate-files

jobs:
  check-duplicates:
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    runs-on: ubuntu-latest
    outputs:
      duplicates_found: ${{ steps.check.outputs.duplicates_found }}
      duplicate_list: ${{ steps.check.outputs.duplicate_list }}
      files_to_delete: ${{ steps.check.outputs.files_to_delete }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check for duplicate filenames
        id: check
        run: |
          echo "Checking for duplicate filenames across HTML, HTML_è¦‹é€ã‚Š, and HTML_æœªç€æ‰‹ folders..."
          
          # Get basenames from all three directories
          html_files=$(find "WAIC-TEST/HTML" -name "*.md" ! -name "README.md" -exec basename {} \; 2>/dev/null | sort)
          miokuri_files=$(find "WAIC-TEST/HTML_è¦‹é€ã‚Š" -name "*.md" -exec basename {} \; 2>/dev/null | sort)
          michakushu_files=$(find "WAIC-TEST/HTML_æœªç€æ‰‹" -name "*.md" -exec basename {} \; 2>/dev/null | sort)
          
          # Find duplicates and files to delete
          issue_body=""
          files_to_delete=""
          duplicates_found=false
          
          # Check HTML vs HTML_æœªç€æ‰‹ (delete from HTML_æœªç€æ‰‹)
          html_vs_michakushu=$(comm -12 <(echo "$html_files") <(echo "$michakushu_files"))
          if [ -n "$html_vs_michakushu" ]; then
            echo "âŒ Duplicates found between HTML and HTML_æœªç€æ‰‹:"
            duplicates_found=true
            for file in $html_vs_michakushu; do
              echo "  - $file"
              html_path=$(find WAIC-TEST/HTML -name "$file" -exec echo {} \;)
              michakushu_path=$(find WAIC-TEST/HTML_æœªç€æ‰‹ -name "$file" -exec echo {} \;)
              echo "    ğŸ“ HTML: $html_path"
              echo "    ğŸ“ HTML_æœªç€æ‰‹: $michakushu_path (å‰Šé™¤å¯¾è±¡)"
              issue_body="$issue_body- \`$file\`\n  - ğŸ“ HTML: \`$html_path\`\n  - ğŸ“ HTML_æœªç€æ‰‹: \`$michakushu_path\` (å‰Šé™¤å¯¾è±¡)\n\n"
              files_to_delete="$files_to_delete$michakushu_path\n"
            done
            echo ""
          fi
          
          # Check HTML vs HTML_è¦‹é€ã‚Š (delete from HTML_è¦‹é€ã‚Š)
          html_vs_miokuri=$(comm -12 <(echo "$html_files") <(echo "$miokuri_files"))
          if [ -n "$html_vs_miokuri" ]; then
            echo "âŒ Duplicates found between HTML and HTML_è¦‹é€ã‚Š:"
            duplicates_found=true
            for file in $html_vs_miokuri; do
              echo "  - $file"
              html_path=$(find WAIC-TEST/HTML -name "$file" -exec echo {} \;)
              miokuri_path=$(find WAIC-TEST/HTML_è¦‹é€ã‚Š -name "$file" -exec echo {} \;)
              echo "    ğŸ“ HTML: $html_path"
              echo "    ğŸ“ HTML_è¦‹é€ã‚Š: $miokuri_path (å‰Šé™¤å¯¾è±¡)"
              issue_body="$issue_body- \`$file\`\n  - ğŸ“ HTML: \`$html_path\`\n  - ğŸ“ HTML_è¦‹é€ã‚Š: \`$miokuri_path\` (å‰Šé™¤å¯¾è±¡)\n\n"
              files_to_delete="$files_to_delete$miokuri_path\n"
            done
            echo ""
          fi
          
          # Check HTML_è¦‹é€ã‚Š vs HTML_æœªç€æ‰‹ (delete from HTML_æœªç€æ‰‹)
          miokuri_vs_michakushu=$(comm -12 <(echo "$miokuri_files") <(echo "$michakushu_files"))
          if [ -n "$miokuri_vs_michakushu" ]; then
            echo "âŒ Duplicates found between HTML_è¦‹é€ã‚Š and HTML_æœªç€æ‰‹:"
            duplicates_found=true
            for file in $miokuri_vs_michakushu; do
              echo "  - $file"
              miokuri_path=$(find WAIC-TEST/HTML_è¦‹é€ã‚Š -name "$file" -exec echo {} \;)
              michakushu_path=$(find WAIC-TEST/HTML_æœªç€æ‰‹ -name "$file" -exec echo {} \;)
              echo "    ğŸ“ HTML_è¦‹é€ã‚Š: $miokuri_path"
              echo "    ğŸ“ HTML_æœªç€æ‰‹: $michakushu_path (å‰Šé™¤å¯¾è±¡)"
              issue_body="$issue_body- \`$file\`\n  - ğŸ“ HTML_è¦‹é€ã‚Š: \`$miokuri_path\`\n  - ğŸ“ HTML_æœªç€æ‰‹: \`$michakushu_path\` (å‰Šé™¤å¯¾è±¡)\n\n"
              files_to_delete="$files_to_delete$michakushu_path\n"
            done
            echo ""
          fi
          
          if [ "$duplicates_found" = true ]; then
            echo "duplicates_found=true" >> $GITHUB_OUTPUT
            echo "duplicate_list<<EOF" >> $GITHUB_OUTPUT
            echo -e "$issue_body" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "files_to_delete<<EOF" >> $GITHUB_OUTPUT
            echo -e "$files_to_delete" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "âœ… No duplicate filenames found across all directories."
            echo "duplicates_found=false" >> $GITHUB_OUTPUT
          fi

  auto-fix-duplicates:
    needs: check-duplicates
    if: needs.check-duplicates.outputs.duplicates_found == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Delete duplicate files
        run: |
          echo "Deleting duplicate files..."
          
          # Delete files listed in files_to_delete
          echo -e "${{ needs.check-duplicates.outputs.files_to_delete }}" | while read -r file; do
            if [ -n "$file" ] && [ -f "$file" ]; then
              echo "Deleting: $file"
              rm "$file"
            fi
          done

      - name: Create Pull Request for duplicate removal
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "ğŸ—‘ï¸ Remove duplicate files across HTML folders [skip ci]"
          title: "ğŸ—‘ï¸ é‡è¤‡ãƒ•ã‚¡ã‚¤ãƒ«ã®è‡ªå‹•å‰Šé™¤"
          body: |
            ## æ¦‚è¦
            HTMLã€HTML_è¦‹é€ã‚Šã€HTML_æœªç€æ‰‹ ãƒ•ã‚©ãƒ«ãƒ€é–“ã§é‡è¤‡ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œå‡ºã—ã€å„ªå…ˆåº¦ã®ä½ã„ãƒ•ã‚©ãƒ«ãƒ€ã‹ã‚‰è‡ªå‹•å‰Šé™¤ã—ã¾ã—ãŸã€‚

            ## å‰Šé™¤ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«
            ${{ needs.check-duplicates.outputs.duplicate_list }}

            ## å‰Šé™¤ãƒ«ãƒ¼ãƒ«
            - å„ªå…ˆåº¦: HTML > HTML_è¦‹é€ã‚Š > HTML_æœªç€æ‰‹
            - é‡è¤‡ãŒè¦‹ã¤ã‹ã£ãŸå ´åˆã€å„ªå…ˆåº¦ã®ä½ã„æ–¹ã‹ã‚‰å‰Šé™¤

            ## ç¢ºèªäº‹é …
            - [ ] å‰Šé™¤ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã¨ä¿æŒã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®çŠ¶æ…‹ç®¡ç†ã«ç ´ç¶»ãŒãªã„ã“ã¨ã‚’ç¢ºèª
            - [ ] å‰Šé™¤ã«ã‚ˆã‚Šå½±éŸ¿ã‚’å—ã‘ã‚‹ä»–ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒãªã„ã“ã¨ã‚’ç¢ºèª
            - [ ] å„ªå…ˆåº¦ãƒ«ãƒ¼ãƒ«ã«å¾“ã£ã¦é©åˆ‡ãªãƒ•ã‚¡ã‚¤ãƒ«ãŒå‰Šé™¤ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª

            ## è‡ªå‹•å‡¦ç†æƒ…å ±
            - **å‡¦ç†æ—¥æ™‚**: ${{ github.event.head_commit.timestamp }}
            - **æ¤œå‡ºã‚³ãƒŸãƒƒãƒˆ**: ${{ github.sha }}
            - **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼**: ${{ github.workflow }}
            - **å®Ÿè¡Œã‚¤ãƒ™ãƒ³ãƒˆ**: ${{ github.event_name }}

            > ã“ã®PRã¯GitHub Actionsã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚ãƒãƒ¼ã‚¸å‰ã«å†…å®¹ã‚’ã”ç¢ºèªãã ã•ã„ã€‚
          branch: ${{ env.BRANCH_PREFIX }}-${{ github.run_number }}
          base: master
          delete-branch: true

